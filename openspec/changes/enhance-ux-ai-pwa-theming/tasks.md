# Implementation Tasks

## 0. Bug Fix - Custom Tags Not Loaded (HIGH PRIORITY) ‚úÖ COMPLETE

- [x] 0.1 Update ConfigLoader to read AI config
  - Read `ai` section from config.yaml
  - Extract `tags`, `model`, `endpoint`, `temperature`
  - Return as separate dict alongside accounts
  - Log loaded AI configuration
  - **Done**: `ConfigLoader.get_ai_config()` and `get_custom_tags()` methods exist

- [x] 0.2 Update sync.py to use AI config from file
  - Call ConfigLoader.load_config() to get ai section
  - Pass `custom_tags` to AIConfig
  - Pass `model`, `endpoint`, `temperature` from config
  - Fall back to defaults if not in config
  - **Done**: `_create_ai_config()` helper uses ConfigLoader methods

- [x] 0.3 Update API sync route similarly
  - Read AI config on startup or per-request
  - Pass custom_tags to AIConfig
  - Ensure consistency with CLI
  - **Done**: `run_sync_task()` loads and uses custom tags

- [x] 0.4 Test custom tags flow end-to-end
  - Add custom tag in Nix config
  - Rebuild and verify in config.yaml
  - Run sync and verify custom tag in prompt
  - Verify classification uses custom tag
  - **Done**: Logs show "Using custom tags from config: [...]"

## 1. Theme Infrastructure ‚úÖ COMPLETE

- [x] 1.1 Create ThemeContext for global theme state
  - Create `web/src/contexts/ThemeContext.tsx`
  - Support three modes: light, dark, system
  - Read initial value from localStorage
  - Detect system preference via `window.matchMedia`
  - Listen for system preference changes
  - Export useTheme hook
  - **Done**: Full implementation in ThemeContext.tsx

- [x] 1.2 Configure MUI dark theme palette
  - Update `web/src/main.tsx`
  - Define light and dark palettes
  - Set primary, secondary, background colors
  - Ensure proper contrast ratios
  - Wrap app in ThemeContext provider
  - **Done**: Light/dark themes defined in ThemeContext.tsx with OLED-friendly dark theme

- [x] 1.3 Create ThemeToggle component
  - Create `web/src/components/ThemeToggle.tsx`
  - Sun icon for light, Moon icon for dark, Auto icon for system
  - IconButton with tooltip
  - Cycle through modes on click
  - Save preference to localStorage
  - **Done**: ThemeToggle.tsx with LightMode/DarkMode/SettingsBrightness icons

- [x] 1.4 Persist theme preference
  - Store mode in localStorage key `axios-theme`
  - Restore on app load
  - Apply `color-scheme` CSS property
  - Set `<meta name="theme-color">` dynamically
  - **Done**: localStorage persistence with cross-tab sync via storage event

## 2. PWA Configuration ‚úÖ COMPLETE

- [x] 2.1 Create logo assets
  - Create/obtain `axios-ai-mail.png` (192x192)
  - Create/obtain `axios-ai-mail-512.png` (512x512)
  - Place in `web/public/`
  - Ensure transparent background for dark mode
  - Consider maskable icon variant
  - **Done**: icon-192.png, icon-512.png, logo.png in web/public/

- [x] 2.2 Create manifest.json
  - Create `web/public/manifest.json`
  - Set name: "Axios AI Mail"
  - Set short_name: "Mail"
  - Set start_url: "/"
  - Set display: "standalone"
  - Set theme_color and background_color
  - Add icons array with both sizes
  - **Done**: Generated by vite-plugin-pwa with all required fields

- [x] 2.3 Install and configure vite-plugin-pwa
  - Add `vite-plugin-pwa` to devDependencies
  - Update `web/vite.config.ts`
  - Configure workbox caching strategy
  - Generate service worker
  - Add registerSW option
  - **Done**: vite.config.ts configured with VitePWA plugin and workbox caching

- [x] 2.4 Update index.html for PWA
  - Add `<link rel="manifest" href="/manifest.json">`
  - Add `<meta name="theme-color">`
  - Add apple-touch-icon link
  - Add mobile-web-app-capable meta tags
  - **Done**: Handled automatically by vite-plugin-pwa

- [x] 2.5 Register service worker
  - Import virtual:pwa-register in main.tsx
  - Register service worker on load
  - Handle update prompts (optional)
  - Log registration success/failure
  - **Done**: Auto-registered by vite-plugin-pwa with registerType: 'autoUpdate'

## 3. Offline Awareness ‚úÖ COMPLETE

- [x] 3.1 Create useOnlineStatus hook
  - Create `web/src/hooks/useOnlineStatus.ts`
  - Use navigator.onLine initial value
  - Listen for 'online' and 'offline' events
  - Return boolean isOnline status
  - Clean up event listeners on unmount
  - **Done**: Full implementation in useOnlineStatus.ts

- [x] 3.2 Create OfflineIndicator component
  - Create `web/src/components/OfflineIndicator.tsx`
  - Show banner/chip when offline
  - Position at top of screen or in topbar
  - Use warning color and offline icon
  - Smooth transition on state change
  - **Done**: OfflineIndicator.tsx with Alert and WifiOff icon

- [x] 3.3 Integrate offline indicator in Layout
  - Import useOnlineStatus hook
  - Conditionally render OfflineIndicator
  - Consider disabling action buttons when offline
  - Add aria-live for accessibility
  - **Done**: Integrated in Layout.tsx

## 4. Branding ‚úÖ COMPLETE

- [x] 4.1 Add logo to topbar
  - Import logo image in Layout/AppBar
  - Add img element with alt text
  - Position on left side of topbar
  - Link to home page (/)
  - Size appropriately (32-40px height)
  - **Done**: Logo in TopBar.tsx with link to home

- [x] 4.2 Unify sidebar and topbar colors
  - Identify current color values
  - Update Sidebar background to match topbar
  - Use theme palette colors
  - Ensure consistency in both light/dark modes
  - Test visual appearance
  - **Done**: Unified in ThemeContext.tsx theme definitions

- [x] 4.3 Add brand styling touches
  - Consider subtle brand accent colors
  - Consistent border radius
  - Unified spacing in navigation
  - Professional typography
  - **Done**: baseTheme with consistent borderRadius (12), typography, component styles

## 5. AI Classification Improvements ‚úÖ COMPLETE

- [x] 5.1 Add confidence extraction to classifier
  - Update `_build_prompt()` to request confidence
  - Parse confidence from LLM JSON response
  - Add confidence field to Classification dataclass
  - Default to 0.8 if not returned
  - Normalize confidence to 0.0-1.0 range
  - **Done**: ai_classifier.py lines 154-174 parse and normalize confidence

- [x] 5.2 Update prompt for confidence score
  - Add confidence instruction to prompt
  - Request confidence as 0.0-1.0 float
  - Explain what high/low confidence means
  - Example: "confidence": 0.85
  - **Done**: Prompt includes confidence instructions (lines 92-104)

- [x] 5.3 Update API response to include confidence
  - Add confidence field to Message response model
  - Store confidence in database (optional)
  - Return in GET /api/messages/{id}
  - Return in GET /api/messages list
  - **Done**: serialize_message includes confidence, API models have field

- [x] 5.4 Display confidence in UI
  - Add confidence indicator to MessageListItem
  - Add confidence badge to MessageDetailPage
  - Use colors: green (high), yellow (medium), red (low)
  - Add tooltip explaining confidence meaning
  - **Done**: ConfidenceBadge.tsx component added to MessageCard and MessageDetailPage

- [ ] 5.5 Document model recommendations
  - Update README with model guidance
  - Add to Nix module comments
  - Include hardware requirements
  - Provide benchmark comparisons
  - Example configurations

## 6. Custom Tags Configuration ‚úÖ COMPLETE

- [x] 6.1 Add custom tags to Nix module
  - Add `ai.customTags` option
  - List of { name, description } objects
  - Merge with default tags
  - Pass to config.yaml
  - **Done**: ai.tags option in Nix module

- [x] 6.2 Update ConfigLoader to read custom tags
  - Parse customTags from config
  - Pass to AIConfig
  - Override or extend default tags
  - **Done**: ConfigLoader.get_custom_tags() method

- [x] 6.3 Update AI classifier to use custom tags
  - Accept custom_tags in AIConfig
  - Build prompt with merged tags
  - Validate against custom tags
  - **Done**: AIClassifier uses custom_tags from AIConfig

## 7. Integration & Polish ‚úÖ MOSTLY COMPLETE

- [x] 7.1 Add theme toggle to topbar
  - Position in topbar (right side, near user actions)
  - Style consistently with other icons
  - Add tooltip for accessibility
  - Test keyboard navigation
  - **Done**: ThemeToggle in TopBar.tsx

- [x] 7.2 Ensure theme persistence across tabs
  - Use storage event listener
  - Sync theme between browser tabs
  - Test multi-tab behavior
  - **Done**: Storage event listener in ThemeContext.tsx

- [ ] 7.3 PWA installability testing
  - Test Chrome/Chromium "Install" prompt on NixOS
  - Verify standalone mode works
  - Note: Safari/iOS testing N/A (NixOS-only project)

- [x] 7.4 Update existing components for dark mode
  - Review all pages for dark mode issues
  - Fix contrast issues
  - Update hardcoded colors to theme colors
  - Test all UI states
  - **Done**: Theme-aware colors in components using theme palette

## 8. Testing

- [ ] 8.1 Write unit tests for ThemeContext
  - Test mode toggle
  - Test localStorage persistence
  - Test system preference detection
  - Test SSR compatibility

- [ ] 8.2 Write tests for useOnlineStatus hook
  - Mock navigator.onLine
  - Test event listener setup/cleanup
  - Test state changes

- [ ] 8.3 Write tests for confidence parsing
  - Test valid confidence values
  - Test missing confidence
  - Test out-of-range values
  - Test normalization

- [ ] 8.4 Manual testing checklist
  - [x] Theme toggle cycles through modes
  - [x] Theme persists after refresh
  - [x] System preference is detected
  - [x] Logo displays in topbar
  - [x] Sidebar and topbar have same color
  - [ ] PWA installs on Chrome/Chromium
  - [x] Offline indicator shows when disconnected
  - [ ] Confidence scores display correctly
  - [x] Dark mode looks correct on all pages
  - [ ] phi3:mini model works correctly
  - [ ] mistral:7b model works correctly

## 9. Documentation

- [ ] 9.1 Update README with new features
  - Document theme toggle
  - Document PWA installation
  - Document model recommendations
  - Add screenshots

- [ ] 9.2 Update Nix module documentation
  - Document ai.model options
  - Document ai.customTags
  - Provide example configurations
  - Hardware recommendations

- [ ] 9.3 Run openspec validate --strict
  - Create spec deltas if needed
  - Verify scenarios cover requirements
  - Fix validation errors

## Dependency Order

```
0. Bug Fix - Custom Tags (0.1-0.4) ‚úÖ COMPLETE
   ‚îî‚îÄ‚îÄ HIGH PRIORITY - Should be done first
   ‚îî‚îÄ‚îÄ No dependencies

1. Theme Infrastructure (1.1-1.4) ‚úÖ COMPLETE
   ‚îî‚îÄ‚îÄ No dependencies

2. PWA Configuration (2.1-2.5) ‚úÖ COMPLETE
   ‚îî‚îÄ‚îÄ Depends on logo assets (2.1)

3. Offline Awareness (3.1-3.3) ‚úÖ COMPLETE
   ‚îî‚îÄ‚îÄ No dependencies

4. Branding (4.1-4.3) ‚úÖ COMPLETE
   ‚îî‚îÄ‚îÄ Depends on logo assets (2.1)
   ‚îî‚îÄ‚îÄ Depends on theme infrastructure (1.x)

5. AI Classification - Confidence (5.1-5.5) ‚úÖ MOSTLY COMPLETE
   ‚îî‚îÄ‚îÄ Depends on bug fix (0.x)
   ‚îî‚îÄ‚îÄ Only 5.5 documentation remains

6. Custom Tags UI (6.1-6.3) ‚úÖ COMPLETE
   ‚îî‚îÄ‚îÄ Depends on bug fix (0.x)

7. Integration (7.1-7.4) ‚úÖ MOSTLY COMPLETE
   ‚îî‚îÄ‚îÄ Depends on all above
   ‚îî‚îÄ‚îÄ Only 7.3 PWA testing remains

8. Testing (8.1-8.4) üîÑ IN PROGRESS
   ‚îî‚îÄ‚îÄ Depends on implementation

9. Documentation (9.1-9.3) ‚è≥ PENDING
   ‚îî‚îÄ‚îÄ Depends on all above
```

## Parallelizable Work

The following can be done in parallel:
- Bug Fix (0.x) ‚úÖ DONE
- Theme (1.x) ‚úÖ DONE
- PWA (2.x) ‚úÖ DONE
- Offline (3.x) ‚úÖ DONE
- AI Confidence (5.x) ‚úÖ MOSTLY DONE
- Branding (4.x) ‚úÖ DONE
- Custom Tags (6.x) ‚úÖ DONE
- Integration (7.x) ‚úÖ MOSTLY DONE
- All testing can be parallelized after implementation
